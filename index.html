<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Refusal & Pass Tracker — Rolling 60 Days</title>
<style>
  :root{
    --gold:#D4AF37;
    --black:#0b0b0b;
    --white:#ffffff;
    --red:#d62828;
    --muted:#f5f4f2;
    --glass: rgba(255,255,255,0.06);
    --pass-gray: #BDBDBD; /* Option C */
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

/* Mobile-first */
html,body{height:100%}
body{
background: linear-gradient(180deg,var(--black) 0%, #0f0f0f 100%);
color:var(--white);
margin:0;
-webkit-font-smoothing:antialiased;
-moz-osx-font-smoothing:grayscale;
padding:14px;
display:flex;
align-items:flex-start;
justify-content:center;
min-height:100vh;
}

.container{
width:100%;
max-width:980px;
}

.header{
display:flex;
gap:12px;
align-items:center;
margin-bottom:12px;
}
.logo{
background:linear-gradient(135deg,var(--gold),#f3d77a);
color:var(--black);
padding:10px 14px;
border-radius:12px;
font-weight:700;
box-shadow:0 6px 20px rgba(0,0,0,0.6);
letter-spacing:0.6px;
}
h1{
font-size:20px;
margin:0;
line-height:1;
}
p.lead{
margin:4px 0 0 0;
color: #dcd6c9;
font-size:13px;
}

.grid{
display:grid;
gap:12px;
grid-template-columns: 1fr;
}

.big-card{
background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
border-radius:14px;
padding:14px;
box-shadow: 0 8px 24px rgba(0,0,0,0.5);
display:flex;
gap:12px;
align-items:center;
justify-content:space-between;
border:1px solid rgba(212,175,55,0.08);
}
.big-left{flex:1}
.big-value{
font-size:38px;
font-weight:900;
color:var(--red);
}
.sub{color:#e9e6df;opacity:0.95;font-size:13px;margin-top:6px}
.big-right{text-align:right;min-width:150px}
.chip{
display:inline-block;
background: linear-gradient(90deg,#0f0f0f, #151515);
padding:6px 10px;
border-radius:999px;
border:1px solid rgba(212,175,55,0.12);
font-weight:700;
font-size:13px;
}

/* Inputs area */
.card{
background:var(--white);
color:var(--black);
border-radius:12px;
padding:12px;
box-shadow:0 8px 18px rgba(0,0,0,0.35);
}
label{display:block;font-size:13px;margin-bottom:6px;font-weight:600}
input[type="date"], input[type="number"], select, input[type="text"]{
width:100%;
padding:10px 12px;
border-radius:8px;
border:1px solid #ddd;
font-size:14px;
box-sizing:border-box;
}
.row{display:flex;gap:8px;flex-wrap:wrap}
.col{flex:1;min-width:120px}
button.btn{
background:var(--gold);
border:none;
color:var(--black);
padding:10px 12px;
border-radius:10px;
font-weight:700;
cursor:pointer;
box-shadow:0 6px 18px rgba(212,175,55,0.12);
transition:transform .08s ease;
}
button.btn:active{transform:translateY(1px)}
.btn-danger{
background:var(--red);
color:var(--white);
border:none;
}

/* entries list */
.entries{
max-height:240px;
overflow:auto;
margin-top:8px;
padding-right:8px;
}
.entry{
display:flex;
align-items:center;
justify-content:space-between;
gap:8px;
padding:10px;
border-radius:8px;
margin-bottom:8px;
background:linear-gradient(90deg, rgba(0,0,0,0.03), rgba(255,255,255,0.01));
border:1px solid rgba(0,0,0,0.06);
}
.entry .left{display:flex;gap:10px;align-items:center;flex-direction:column;align-items:flex-start}
.entry .dot-wrapper{display:flex;gap:10px;align-items:center}
.dot{
width:12px;height:12px;border-radius:50%;
box-shadow:0 1px 4px rgba(0,0,0,0.3)
}
.dot.refused{background:var(--red)}
.dot.work{background:var(--gold)}
.dot.passed{background:var(--pass-gray)}
.entry small{display:block;color:#6b6b6b;font-size:12px}

/* stats row */
.stats{
display:flex;
gap:10px;
margin-top:10px;
flex-wrap:wrap;
}
.stat{
background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
border-radius:10px;padding:12px;flex:1;min-width:120px;
border:1px solid rgba(212,175,55,0.06);
}
.stat h3{margin:0;font-size:20px;color:var(--gold);font-weight:800}
.stat p{margin:6px 0 0 0;color:#dad6cc;font-size:13px}

/* calendar */
.calendar-card{
background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
border-radius:12px;
padding:12px;
border:1px solid rgba(212,175,55,0.06);
}
.cal-grid{
display:grid;
grid-template-columns: repeat(10, 1fr);
gap:8px;
align-items:center;
}
.cal-day{
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
padding:8px;
min-height:54px;
border-radius:8px;
background:rgba(255,255,255,0.02);
color:#e8e6e3;
font-size:12px;
cursor:pointer;
border:1px dashed rgba(255,255,255,0.02);
}
/* Highlight current day */
.cal-day.is-today{
  border:2px solid var(--gold); /* Highlight with a gold border */
  background:rgba(212,175,55,0.1); /* Slightly darker background */
  box-shadow:0 0 10px rgba(212,175,55,0.3); /* Subtle glow */
}
/* End current day highlight */
.cal-day .date{font-size:11px; color: #ccc;}
.cal-dot{
width:12px;height:12px;border-radius:50%;margin-top:6px;
box-shadow:0 6px 18px rgba(0,0,0,0.45);
}
.cal-dot.refused{background:var(--red)}
.cal-dot.work{background:var(--gold)}
.cal-dot.passed{background:var(--pass-gray)}
.cal-dot.none{background:transparent;border:1px solid rgba(255,255,255,0.06)}

.legend{display:flex;gap:8px;align-items:center;margin-top:10px}
.legend span{font-size:13px;color:#d6d2c6}

.muted{font-size:12px;color:#cfc9bf;margin-top:8px}

@media(min-width:760px){
.grid{grid-template-columns: 1fr 380px; align-items:start;}
.big-card{grid-column:span 2}
}
@media(max-width:420px){
.cal-grid{grid-template-columns: repeat(5, 1fr)}
.cal-day{min-height:48px;padding:6px}
.big-value{font-size:30px}
} </style>

</head>
<body>
  <div class="container" role="application" aria-label="Refusal and Pass tracker">
    <div class="header">
      <div><img src="./martini.png" style="height: auto; width: 60px; display: flex; flex-wrap: wrap; border-radius: 50px;"></div>
      <div>
        <h1>Refusal & Pass Tracker — Rolling 60 Days</h1>
        <p class="lead">Track shifts you <strong>refused</strong> (denied), <strong>worked</strong>, and <strong>passed</strong> (offered but passed for tracking only). The 60-day window includes today and the prior 59 days.</p>
      </div>
    </div>

<div class="grid">
  <main>
    <div class="big-card" id="dashboard">
      <div class="big-left">
        <div class="big-value" id="calendarPercent">—%</div>
        <div class="sub">Refusal % (calculated from calendar — excludes Pass)</div>
        <div class="sub" id="ratioText">— refused / — worked</div>
      </div>
      <div class="big-right">
        <div class="chip" id="currentRefChip">Current refused %: —</div>
        <div style="height:10px"></div>
        <div class="muted" id="windowRangeSmall">Window: — → —</div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card" aria-live="polite">
      <label for="currentRef">Enter current refusal percentage (external/current metric)</label>
      <div class="row">
        <div class="col">
          <input id="currentRef" type="number" min="0" max="100" step="0.1" placeholder="e.g. 22.5" />
        </div>
        <div style="width:120px">
          <button id="saveCurrent" class="btn" title="Save current refusal percentage">Save</button>
        </div>
      </div>

      <hr style="margin:12px 0; border:none; border-top:1px solid rgba(0,0,0,0.06)" />

      <label for="entryDate">Add / Edit a date</label>
      <div class="row" style="align-items:end">
        <div class="col">
          <input type="date" id="entryDate" />
        </div>
        <div style="width:140px">
          <select id="entryType" aria-label="Mark as worked refused or passed">
            <option value="worked">Worked (accepted)</option>
            <option value="refused">Refused (denied shift)</option>
            <option value="passed">Passed (offered — for tracking only)</option>
          </select>
        </div>
        <div style="width:100px">
          <button id="addEntry" class="btn">Add</button>
        </div>
        <div style="width:100px">
          <button id="clearOutside" class="btn btn-danger" title="Remove entries older than 60 days">Clean old</button>
        </div>
      </div>
      
      <div id="notesContainer" style="margin-top: 10px; display:none;">
        <label for="entryNotes" style="font-weight:400; font-size:12px">Optional Notes (e.g., FMLA, Training, etc.):</label>
        <input type="text" id="entryNotes" placeholder="Reason for day worked, if unusual (optional)" />
      </div>

      <div class="muted" style="margin-top:8px">Tip: tap a dot in the calendar to jump that date into the input. Dates outside the 60-day window are stored but not counted in calculations (except passes are still tracked separately).</div>

      <div class="entries" id="entriesList" style="margin-top:12px" aria-label="Recent entries"></div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <strong>60-day calendar</strong>
      <div class="calendar-card" style="margin-top:10px">
        <div class="cal-grid" id="calGrid" aria-hidden="false"></div>
        <div class="legend" aria-hidden="false" style="margin-top:8px">
          <div style="display:flex;align-items:center;gap:8px"><span class="cal-dot work" style="width:14px;height:14px"></span><span>Worked</span></div>
          <div style="display:flex;align-items:center;gap:8px;margin-left:12px"><span class="cal-dot refused" style="width:14px;height:14px"></span><span>Refused</span></div>
          <div style="display:flex;align-items:center;gap:8px;margin-left:12px"><span class="cal-dot passed" style="width:14px;height:14px"></span><span>Passed (tracked only)</span></div>
          <div style="display:flex;align-items:center;gap:8px;margin-left:12px"><span class="cal-dot none" style="width:14px;height:14px;border-radius:3px"></span><span>No entry</span></div>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Detailed stats — last 60 days</strong>
        <small style="color:#7b7b7b" id="windowRange">Window: — → —</small>
      </div>

      <div class="stats">
        <div class="stat">
          <h3 id="countRefused">0</h3>
          <p>Days refused (last 60 days)</p>
        </div>
        <div class="stat">
          <h3 id="countWorked">0</h3>
          <p>Days worked (last 60 days)</p>
        </div>
        <div class="stat">
          <h3 id="countPassed">0</h3>
          <p>Days passed (last 60 days) — tracked only</p>
        </div>
        <div class="stat">
          <h3 id="daysTotal">0</h3>
          <p>Total counted days (refused + worked)</p>
        </div>
      </div>

      <div class="muted">Pass days are displayed but do not affect the refusal percentage calculation. Data persists locally in your browser.</div>
    </div>

  </main>

  <aside>
    <div class="card" style="margin-bottom:12px">
      <h3 style="margin:0 0 8px 0">Quick controls</h3>
      <div style="display:grid;gap:8px">
        <button id="markTodayRef" class="btn">Mark Today Refused</button>
        <button id="markTodayWork" class="btn">Mark Today Worked</button>
        <button id="markTodayPass" class="btn">Mark Today Passed</button>
        </div>
    </div>

    <div class="card" style="text-align:center">
      <div style="font-weight:900;font-size:28px;color:var(--red)" id="miniPercent">—%</div>
      <div class="muted">Calendar refusal %</div>
      <div style="height:12px"></div>
      <div style="font-size:13px;color:#8f8f8f">Colors:
        <span style="display:inline-block;width:12px;height:12px;background:var(--gold);border-radius:3px;margin:0 6px;vertical-align:middle"></span>Worked
        <span style="display:inline-block;width:12px;height:12px;background:var(--red);border-radius:3px;margin:0 6px;vertical-align:middle"></span>Refused
        <span style="display:inline-block;width:12px;height:12px;background:var(--pass-gray);border-radius:3px;margin:0 6px;vertical-align:middle"></span>Passed
      </div>
    </div>

  </aside>
</div>

  </div>

<script>
/* REFUSAL & PASS TRACKER
   Rolling 60-day window: includes today and 59 prior days.
*/

const STORAGE_KEY = 'REF60_ENTRIES_v1';
const CURRENT_KEY = 'REF60_CURRENT_v1';

// ******************************************************
// CORE DATE FUNCTIONS (FIXED for Timezone/Boundary Issues)
// ******************************************************

function toLocalISO(d) {
  // Converts date to YYYY-MM-DD using local time (fixed)
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

function todayISO(offsetDays = 0){
  const d = new Date();
  d.setDate(d.getDate() + offsetDays);
  return toLocalISO(d);
}

// *** FIX 1: windowStartISO - Returns '2025-10-02' reliably ***
function windowStartISO(){
  const d = new Date();
  
  // 1. Subtract 60 days. 
  d.setDate(d.getDate() - 60); 
  
  // 2. Add 1 day. Compensates for the time zone slip, forcing the date to 10/02.
  d.setDate(d.getDate() + 1); 
  
  return toLocalISO(d); // Returns '2025-10-02'
}

function windowEndISO(){ 
  const d = new Date();
  return toLocalISO(d);
}


function loadEntries(){
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  catch(e){ return []; }
}
function saveEntries(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
function loadCurrent(){ 
  const v = localStorage.getItem(CURRENT_KEY);
  if(v === null || v === '') return null;
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : null;
}
function saveCurrent(n){ localStorage.setItem(CURRENT_KEY, String(n)); }

function addOrReplace(dateISO, type, notes = ''){
  if(!dateISO) return;
  if(!['refused','worked','passed'].includes(type)) return;
  const entries = loadEntries();
  const idx = entries.findIndex(e => e.date === dateISO);
  
  // Clean up notes if not 'worked'
  const finalNotes = (type === 'worked' ? notes : ''); 
  
  const entry = { date: dateISO, type: type, created: Date.now(), notes: finalNotes };
  
  if(idx >= 0) {
    // Preserve old notes if not provided in the current update
    if (idx >= 0 && !notes && entries[idx].type === type) {
        entry.notes = entries[idx].notes;
    }
    entries[idx] = entry; 
  } else {
    entries.push(entry);
  }
  
  entries.sort((a,b) => b.date.localeCompare(a.date));
  saveEntries(entries);
  
  // Clear notes input after saving
  document.getElementById('entryNotes').value = ''; 
  
  renderAll();
}

function removeEntry(dateISO){
  let entries = loadEntries();
  entries = entries.filter(e => e.date !== dateISO);
  saveEntries(entries);
  renderAll();
}

function removeOlderThanWindow(){
  removeOlderThanWindowImpl();
}

// *** FIX 2: computeWindowStats - Uses 1-day-prior filter to ensure inclusive counting (10/02 included, 10/01 excluded) ***
function computeWindowStats(){
  // 'visualStart' is the date displayed (e.g., '2025-10-02')
  const visualStart = windowStartISO(); 
  const end = windowEndISO(); 
  
  // Create a filter boundary one day *before* the visual start.
  const filterDate = new Date(visualStart + 'T00:00:00'); // Ensure date is parsed at midnight UTC
  filterDate.setDate(filterDate.getDate() - 1); 
  const filterStart = toLocalISO(filterDate); // e.g., '2025-10-01'
  
  // Filter: Use e.date > filterStart (e.g., > '2025-10-01') to ensure 
  // '2025-10-02' is unambiguously included in the result set.
  const entries = loadEntries().filter(e => e.date > filterStart && e.date <= end);
  
  // Standard calculation logic
  let refused = 0, worked = 0, passed = 0;
  entries.forEach(e => {
    if(e.type === 'refused') refused++;
    else if(e.type === 'worked') worked++;
    else if(e.type === 'passed') passed++;
  });
  
  const totalCounted = refused + worked; 
  
  // Return the visualStart date for display, but the corrected counts
  return { 
    refused, 
    worked, 
    passed, 
    total: totalCounted, 
    percent: totalCounted === 0 ? null : (refused / totalCounted * 100), 
    start: visualStart, 
    end 
  };
}

/* Build calendar UI (60 day grid). Click a day to edit/quick-add */
// *** FIX 3: buildCalendar - Uses the ISO string directly to construct the exact 10/02 start date ***
function buildCalendar(){
  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';
  
  // Use the ISO string + 'T00:00:00' to create a date object for the loop 
  // that unambiguously starts on the correct day (10/02) at the local midnight.
  const visualStartISO = windowStartISO();
  const start = new Date(visualStartISO + 'T00:00:00'); 
  
  const entriesMap = {};
  loadEntries().forEach(e => entriesMap[e.date] = e); 

  const todayIso = todayISO(); 

  // The loop runs exactly 60 times (i=0 to i=59)
  for(let i=0;i<60;i++){
    const d = new Date(start);
    d.setDate(start.getDate() + i); 
    
    const iso = toLocalISO(d); 
    
    const node = document.createElement('div');
    node.className = 'cal-day';
    node.dataset.date = iso;
    
    if (iso === todayIso) {
      node.classList.add('is-today');
    }
    
    const entry = entriesMap[iso];

    const day = document.createElement('div');
    day.className = 'date';
    // show small label: Month/day only for readability
    const mm = (d.getMonth()+1) + '/' + d.getDate();
    day.textContent = mm;
    
    const dot = document.createElement('div');
    dot.className = 'cal-dot none';
    
    if(entry) {
        if(entry.type === 'refused') { dot.className = 'cal-dot refused'; }
        else if(entry.type === 'worked') { dot.className = 'cal-dot work'; }
        else if(entry.type === 'passed') { dot.className = 'cal-dot passed'; }
    }

    node.appendChild(day);
    node.appendChild(dot);

    node.onclick = () => {
      // clicking populates the add/edit form for quick edit
      document.getElementById('entryDate').value = iso;
      
      const typeSelect = document.getElementById('entryType');
      const notesInput = document.getElementById('entryNotes');
      
      if(entry){
          typeSelect.value = entry.type;
          notesInput.value = entry.notes || '';
      } else {
          typeSelect.value = 'refused';
          notesInput.value = '';
      }
      
      // Toggle notes visibility
      if(typeSelect.value === 'worked') document.getElementById('notesContainer').style.display = 'block';
      else document.getElementById('notesContainer').style.display = 'none';

      // scroll to top of inputs on small screens
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // hover title (helpful on desktop)
    let titleText = iso + (entry ? (' — ' + entry.type) : ' — no entry');
    if(entry && entry.notes) titleText += ` (${entry.notes})`;
    node.title = titleText;

    grid.appendChild(node);
  }
}

function renderEntriesList(){
  const list = document.getElementById('entriesList');
  list.innerHTML = '';
  const entries = loadEntries();
  if(entries.length === 0){
    list.innerHTML = '<div style="opacity:0.8;color:#9e9e9e">No entries yet. Add a date above or tap a calendar day.</div>';
    return;
  }
  // show latest first
  entries.slice(0,200).forEach(e => {
    const el = document.createElement('div'); el.className = 'entry';
    
    const left = document.createElement('div'); left.className='left';
    
    const dotWrapper = document.createElement('div'); dotWrapper.className='dot-wrapper';
    const dot = document.createElement('span'); dot.className = 'dot ' + (e.type === 'refused' ? 'refused' : (e.type === 'worked' ? 'work' : 'passed'));
    dotWrapper.appendChild(dot);
    
    const dt = document.createElement('div');
    const dTitle = document.createElement('div'); dTitle.textContent = e.date; dTitle.style.fontWeight = 700;
    
    const dSub = document.createElement('small'); 
    if(e.type === 'refused') dSub.textContent = 'Refused (denied shift)';
    else if(e.type === 'worked') dSub.textContent = 'Worked (accepted)';
    else dSub.textContent = 'Passed (offered — tracked only)';
    
    dotWrapper.appendChild(dTitle);
    dt.appendChild(dotWrapper); 
    dt.appendChild(dSub);
    
    // Display Notes if present
    if (e.notes) {
        const notesEl = document.createElement('div');
        notesEl.style.fontSize = '12px';
        notesEl.style.color = '#BDBDBD'; // Light gray color
        notesEl.style.marginTop = '4px';
        notesEl.textContent = `Note: ${e.notes}`;
        dt.appendChild(notesEl);
    }
    
    left.appendChild(dt);

    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
    const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.style.padding='6px 8px'; editBtn.textContent='Edit';
    editBtn.onclick = () => {
      document.getElementById('entryDate').value = e.date;
      document.getElementById('entryType').value = e.type;
      document.getElementById('entryNotes').value = e.notes || '';
      
      // Toggle notes visibility
      if(e.type === 'worked') document.getElementById('notesContainer').style.display = 'block';
      else document.getElementById('notesContainer').style.display = 'none';

      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    const delBtn = document.createElement('button'); delBtn.className='btn btn-danger'; delBtn.style.padding='6px 8px'; delBtn.textContent='Delete';
    delBtn.onclick = () => { if(confirm('Delete entry for ' + e.date + '?')) removeEntry(e.date); };
    right.appendChild(editBtn); right.appendChild(delBtn);

    el.appendChild(left); el.appendChild(right);
    list.appendChild(el);
  });
}

function renderAll(){
  // window labels
  const start = windowStartISO(), end = windowEndISO();
  document.getElementById('windowRange').textContent = `${start} → ${end}`;
  document.getElementById('windowRangeSmall').textContent = `Window: ${start} → ${end}`;

  // build calendar
  buildCalendar();

  // entries list
  renderEntriesList();

  // stats
  const s = computeWindowStats();
  document.getElementById('countRefused').textContent = s.refused;
  document.getElementById('countWorked').textContent = s.worked;
  document.getElementById('countPassed').textContent = s.passed;
  document.getElementById('daysTotal').textContent = s.total;

  // big percent displays
  const pctEl = document.getElementById('calendarPercent');
  const miniPct = document.getElementById('miniPercent');
  if(s.percent === null){
    pctEl.textContent = '—%';
    miniPct.textContent = '—%';
    // FIX: Show calendar derivation text
    document.getElementById('ratioText').textContent = `— refused / — worked `;
  } else {
    const formatted = s.percent.toFixed(1) + '%';
    pctEl.textContent = formatted;
    miniPct.textContent = formatted;
    // FIX: Show calendar derivation text
    document.getElementById('ratioText').textContent = `${s.refused} refused / ${s.worked} worked `;
  }

  // current external metric
  const cur = loadCurrent();
  const chip = document.getElementById('currentRefChip');
  if(cur === null) chip.textContent = 'Current refused %: —';
  else chip.textContent = 'Current refused %: ' + Number(cur).toFixed(1) + '%';
}

/* Small UX helpers */
function flash(msg){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.position='fixed';
  el.style.left='50%';
  el.style.top='18px';
  el.style.transform='translateX(-50%)';
  el.style.background='rgba(0,0,0,0.78)';
  el.style.color='white';
  el.style.padding='8px 12px';
  el.style.borderRadius='8px';
  el.style.boxShadow='0 8px 30px rgba(0,0,0,0.6)';
  el.style.zIndex=9999;
  document.body.appendChild(el);
  setTimeout(()=> el.style.opacity='0',1400);
  setTimeout(()=> el.remove(),2000);
}

// Function to toggle Notes visibility
function toggleNotesField(){
    const type = document.getElementById('entryType').value;
    const notesContainer = document.getElementById('notesContainer');
    if (type === 'worked') {
        notesContainer.style.display = 'block';
    } else {
        notesContainer.style.display = 'none';
        document.getElementById('entryNotes').value = ''; // Clear notes when switching away
    }
}

/* Init and event wiring */
function init(){
  // set date input default to today
  document.getElementById('entryDate').value = todayISO();

  // load current
  const cur = loadCurrent();
  if(cur !== null) document.getElementById('currentRef').value = Number(cur).toFixed(1);

  // Toggle notes on type change
  document.getElementById('entryType').addEventListener('change', toggleNotesField);
  toggleNotesField(); // Run once on init to hide/show initially

  document.getElementById('saveCurrent').addEventListener('click', () => {
    const v = parseFloat(document.getElementById('currentRef').value);
    if(Number.isFinite(v) && v >= 0 && v <= 100){
      saveCurrent(v);
      renderAll();
      flash('Saved current refusal %');
    } else alert('Enter a number between 0 and 100 for the current refusal percentage.');
  });

  document.getElementById('addEntry').addEventListener('click', () => {
    const date = document.getElementById('entryDate').value;
    const type = document.getElementById('entryType').value;
    const notes = document.getElementById('entryNotes').value.trim();
    
    if(!date){ alert('Please choose a date.'); return; }
    if(!['refused','worked','passed'].includes(type)){ alert('Select refused, worked, or passed.'); return; }
    
    addOrReplace(date, type, notes);
    flash('Saved entry for ' + date);
  });

  document.getElementById('markTodayRef').addEventListener('click', () => addOrReplace(todayISO(), 'refused'));
  document.getElementById('markTodayWork').addEventListener('click', () => addOrReplace(todayISO(), 'worked'));
  document.getElementById('markTodayPass').addEventListener('click', () => addOrReplace(todayISO(), 'passed'));

  document.getElementById('clearOutside').addEventListener('click', () => {
    if(confirm('Remove entries older than the current 60-day window?')) removeOlderThanWindowImpl();
  });

  // keyboard-friendly
  document.getElementById('entryDate').addEventListener('keydown',(e)=>{ if(e.key==='Enter') document.getElementById('addEntry').click(); });
  document.getElementById('entryType').addEventListener('keydown',(e)=>{ if(e.key==='Enter') document.getElementById('addEntry').click(); });
  document.getElementById('entryNotes').addEventListener('keydown',(e)=>{ if(e.key==='Enter') document.getElementById('addEntry').click(); });

  renderAll();
}

// *** FIX 4: removeOlderThanWindowImpl - Uses 1-day-prior filter to ensure inclusive cleaning (10/02 kept, 10/01 deleted) ***
function removeOlderThanWindowImpl(){
  const visualStart = windowStartISO(); // The date we want to KEEP (e.g., 10/02)
  
  // Create a filter boundary one day *before* the visual start date.
  const filterDate = new Date(visualStart + 'T00:00:00'); 
  filterDate.setDate(filterDate.getDate() - 1); 
  const filterStart = toLocalISO(filterDate); // This becomes the day *before* the window
  
  let entries = loadEntries();
  
  // Filter: Keep entries where date is GREATER THAN the day before the window starts (e.g., > 10/01).
  entries = entries.filter(e => e.date > filterStart);
  
  saveEntries(entries);
  renderAll();
  flash('Cleaned entries older than ' + visualStart);
}

init();
</script>

</body>
</html>